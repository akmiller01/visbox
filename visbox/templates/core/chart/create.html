{% extends 'core/base.html' %}

    {% block title %} Create chart {% endblock %}
    {% block head %}
    {% load staticfiles %} 
    <script type="text/javascript" src='{% static 'core/js/common.js' %}'></script>
    <script type="text/javascript" src='{% static 'core/js/di-charts-1.1.1.min.js' %}'></script>
    <link rel="stylesheet" href='{% static 'core/js/di-charts-1.1.1.css' %}'>
    <style>
            
    button {display:block;}

    </style>
    {% endblock %}    
    {% block content %}
    <div style="float:left;width:20%;overflow-y:scroll;height:100%;">
      <form id="visform" method="post" action="{% url 'core.views.createVis' chart dataset.pk %}">
        {% csrf_token %}
      <a href="#" onclick="$(this).next().slideToggle();" style="display:block;">&gt; Customize and style</a>
      <div class="toggle">
      {{form.as_p}}
      </div>
      <button type="submit" onclick="$('div.toggle').slideDown()">Save chart and configuration</button>
      </form>
      <script>
        {% load staticfiles %}   
        crowbar = function () {
                  var e = document.createElement('script'); e.setAttribute('src',
                  '{% static 'core/js/svg-crowbar.js' %}'
                  ); e.setAttribute('class', 'svg-crowbar'); document.body.appendChild(e);

        };
      </script>
      <button id="print" onclick="crowbar()">Export as vector</button>
    </div>
    <div style="float:left;width:80%" id="chart">
    </div>
<script>
$('#visform').on('keyup keypress', function(e) {
  var keyCode = e.keyCode || e.which;
  if (keyCode === 13) { 
    e.preventDefault();
    return false;
  }
});
d3.csv("{% url 'core.views.csv' dataset.pk %}",function(error, csvDat) {
    {% if visualisation %}
      var config = JSON.parse('{{visualisation.get_config|safe}}');
      DiCharts.draw({element:document.getElementById('chart'),config:config,data:csvDat});
    {% endif %}
    function update() {
        $('#chart').html("");
        var config = form2config("#visform");
        console.log(config);
        console.log(csvDat);
        DiCharts.draw({element:document.getElementById('chart'),config:config,data:csvDat});
    };
    update();
    $('select').change(function(){update()});
    $('input').change(function(){update()});
});
</script>
{% endblock %}
