{% extends 'core/base.html' %}

    {% block title %} Edit chart {% endblock %}
    {% block head %}
    <style>
    button {display:block;margin-bottom:10px;}
    .chart {float:left;}
    </style>
    {% endblock %}    
    {% block content %}
    <div style="float:left;width:20%;overflow-y:scroll;height:100%;">
      <form id="visform" method="post" action="{% url 'core.views.editVis' visualisation.pk %}">
        <input type="hidden" name="chart_type" value="bar">
        <input type="hidden" name="datasetPK" value="{{dataset.pk}}">
        {% csrf_token %}
        {% include 'core/chart/form.html' %}
      <button type="submit" onclick="$('div.toggle').slideDown()">Save</button>
      </form>
      <button id="print" onclick="domExport('capture','svg')">Export as vector</button>
      <button id="print" onclick="domExport('capture','png')">Export as PNG</button>
    </div>
    <div style="max-width:75%;" class="chart" id="capture">
			<div id="chart"></div>
    </div>
    <script>
    //Initial load
    var flatConfig = JSON.parse('{{visualisation.get_flat_config|safe}}');
    for(var key in flatConfig){
      var value = flatConfig[key];
      if(typeof(value) === "boolean"){
        $("[name='"+key+"']").prop("checked",value);
      }else{
        $("[name='"+key+"']").val(value);
      }
    }
    resize_via_config(".chart",flatConfig);
    $('#visform').on('keyup keypress', function(e) {
      var keyCode = e.keyCode || e.which;
      if (keyCode === 13) { 
        e.preventDefault();
        return false;
      }
    });
    d3.csv("{% url 'core.views.csv' dataset.pk %}",function(error, csvDat) {
      //Initial draw with config, subsequent draws with form2config
      var config = JSON.parse('{{visualisation.get_config|safe}}');
      var filter_by = flatConfig.filter_by,
      selectedFilter = flatConfig.filter_selection,
      sort = flatConfig.sort,
      sort_direction = flatConfig.sort_direction,
      divisor = parseFloat(flatConfig.unit_divisor),
      linearAxis = flatConfig["config.linearAxis.indicator"];
      var data = filter_and_sort(filter_by,selectedFilter,sort,sort_direction,divisor,linearAxis,csvDat);
      DiCharts.draw({element:document.getElementById('chart'),config:config,data:data});
      function update() {
        $('#chart').html("");
        resize_via_form(".chart");
        var filter_by = $("[name='filter_by']").val(),
        selectedFilter = $("[name='filter_selection']").val(),
        sort = $("[name='sort']").val(),
        sort_direction = $("[name='sort_direction']").val(),
        divisor = parseFloat($("[name='unit_divisor']").val()),
        linearAxis = $("[name='config.linearAxis.indicator']").val();
        var data = filter_and_sort(filter_by,selectedFilter,sort,sort_direction,divisor,linearAxis,csvDat);
        var config = form2config("#visform");
        DiCharts.draw({element:document.getElementById('chart'),config:config,data:data});
      };
      $('select').change(function(){update()});
      $('input').change(function(){update()});
    });
    </script>
    {% endblock %}
